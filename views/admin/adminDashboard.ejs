<%-include('../layouts/adminHeader.ejs')%>
<%-include('../layouts/adminSidebar.ejs')%>

        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
            <!-- ============================================================== -->
            <!-- Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <div class="page-breadcrumb">
                <div class="row">
                    <div class="col-7 align-self-center">
                        <h3 class="page-title text-truncate text-dark font-weight-medium mb-1">Good Morning Admin!</h3>
                        <!-- <div class="d-flex align-items-center">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb m-0 p-0">
                                    <li class="breadcrumb-item"><a href="index.html">Dashboard</a>
                                    </li>
                                </ol>
                            </nav>
                        </div> -->
                    </div>
                    <!-- <div class="col-5 align-self-center">
                        <div class="customize-input float-right">
                            <select class="custom-select custom-select-set form-control bg-white border-0 custom-shadow custom-radius">
                                <option selected>Aug 19</option>
                                <option value="1">July 19</option>
                                <option value="2">Jun 19</option>
                            </select>
                        </div>
                    </div> -->
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid">
                <!-- *************************************************************** -->
                <!-- Start First Cards -->
                <!-- *************************************************************** -->
                <div class="card-group">
                    <div class="card border-right">
                        <div class="card-body">
                            <div class="d-flex d-lg-flex d-md-block align-items-center">
                                <div>
                                    <div class="d-inline-flex align-items-center">
                                        <h2 class="text-dark mb-1 font-weight-medium"><%= userCount %></h2>
                                        <!-- <span
                                            class="badge bg-primary font-12 text-white font-weight-medium badge-pill ml-2 d-lg-block d-md-none">+18.33%
                                        </span> -->
                                    </div>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">Total Clients</h6>
                                </div>
                                <div class="ml-auto mt-md-3 mt-lg-0">
                                    <span class="opacity-7 text-muted"><i data-feather="user"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-right">
                        <div class="card-body">
                            <div class="d-flex d-lg-flex d-md-block align-items-center">
                                <div>
                                    <h2 class="text-dark mb-1 w-100 text-truncate font-weight-medium"><sup
                            class="set-doller"></sup><%= totalDeliveredAmount %></h2>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">Toatal Earning
                                    </h6>
                                </div>
                                <div class="ml-auto mt-md-3 mt-lg-0">
                                    <span class="opacity-7 text-muted"><i data-feather="dollar-sign"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-right">
                        <div class="card-body">
                            <div class="d-flex d-lg-flex d-md-block align-items-center">
                                <div>
                                    <div class="d-inline-flex align-items-center">
                                        <h2 class="text-dark mb-1 font-weight-medium"><%= orderCount%></h2>
                                        <!-- <span
                                            class="badge bg-danger font-12 text-white font-weight-medium badge-pill ml-2 d-md-none d-lg-block">-18.33%</span> -->
                                    </div>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">Total Orders</h6>
                                </div>
                                <div class="ml-auto mt-md-3 mt-lg-0">
                                    <span class="opacity-7 text-muted"><i data-feather="file-plus"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex d-lg-flex d-md-block align-items-center">
                                <div>
                                    <h2 class="text-dark mb-1 font-weight-medium"><%=totalcouponDiscount %></h2>
                                    <h6 class="text-muted font-weight-normal mb-0 w-100 text-truncate">
                                        TotalDiscount
                                    </h6>
                                </div>
                                <div class="ml-auto mt-md-3 mt-lg-0">
                                    <span class="opacity-7 text-muted"><i data-feather="globe"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- *************************************************************** -->
                <!-- End First Cards -->
                <!-- *************************************************************** -->
                <!-- *************************************************************** -->
                <!-- Start Sales Charts Section -->
                <!-- *************************************************************** -->
                <div class="row">
                    <div class="col-lg-4 col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Total Sales</h4>
                                <div id="campaign-v2" class="mt-2" style="height:283px; width:100%;"></div>
                                <ul class="list-style-none mb-0">
                                    <li>
                                        <i class="fas fa-circle text-primary font-10 mr-2"></i>
                                        <span class="text-muted">Direct Sales</span>
                                        <span class="text-dark float-right font-weight-medium">$2346</span>
                                    </li>
                                    <li class="mt-3">
                                        <i class="fas fa-circle text-danger font-10 mr-2"></i>
                                        <span class="text-muted">Referral Sales</span>
                                        <span class="text-dark float-right font-weight-medium">$2108</span>
                                    </li>
                                    <li class="mt-3">
                                        <i class="fas fa-circle text-cyan font-10 mr-2"></i>
                                        <span class="text-muted">Affiliate Sales</span>
                                        <span class="text-dark float-right font-weight-medium">$1204</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Net Income</h4>
                                <div class="net-income mt-4 position-relative" style="height:294px;"></div>
                                <ul class="list-inline text-center mt-5 mb-2">
                                    <li class="list-inline-item text-muted font-italic">Sales for this month</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-4 col-md-12">
                        <div class="card" style="height:470px;">
                            <div class="card-body">
                                <h4 class="card-title mb-4">Sales Report</h4>
                                <div>
                                    <form action="/admin/salesreport" method="POST" id="filterForm">
                                        <div class="row align-items-center">
                                            <label for="startDate" class="col-md-4 col-12">Start Date:</label>
                                            <input type="date" required id="startDate" name="startDate"
                                                class="col-md-8 col-12 form-control mb-2">
                                        </div>

                                        <div class="row align-items-center">
                                            <label for="endDate" class="col-md-4 col-12">End Date:</label>
                                            <input type="date" required id="endDate" name="endDate"
                                                class="col-md-8 col-12 form-control mb-2">
                                        </div>

                                        <button type="submit" class="btn btn-primary">Generate Report</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>


                



                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-4">
                                    <h4 class="card-title">Top Sellers</h4>
                                </div>
                                <div class="container">
                                    <h1>Top Selling Products</h1>
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Product Name</th>
                                                <th>Total Sold</th>
                                                <th>Image</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% topSellingProducts.forEach((product, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= product.productDetails.name %></td>
                                                    <td><%= product.totalSold %></td>
                                                    <td><img src="/uploads/<%= product.productDetails.image[3] %>" alt="Product Image" style="max-width: 50px;"></td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                
                                    <h1>Top Selling Categories</h1>
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Category Name</th>
                                                <th>Total Sold</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% topSellingCategories.forEach((category, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= category.categoryDetails[0].name %></td>
                                                    <td><%= category.totalSold %></td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 col-lg-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Sales Chart</h4>
                                <!-- <div>
                                    <canvas id="bar-chart" height="150"></canvas>
                                </div> -->
                                <div class="col-lg-3">
                                    <div class="card card-body mb-4">
                                      <article class="icontext">
                                        <span class="icon icon-sm rounded-circle bg-info-light"
                                          ><i class="text-info material-icons md-shopping_basket"></i
                                        ></span>
                                        <div class="text">
                                          <h6 class="mb-1 card-title">Monthly Earning</h6>
                                          <span>₹<%= montlyEarning%></span>
                                        </div>
                                      </article>
                                    </div>
                                  </div>
                                </div>
                        
                                <div
                                    class="row"
                                    id="gragh"
                                    data-monthlyData="<%= JSON.stringify(monthlyData) %>"
                                >
                                <div class="container">
                                    <div class="filters">
                                        <label for="startDate">Select Month</label>
                                        <input
                                            class="btn"
                                            style="border: 1px solid black"
                                            type="month"
                                            id="filter"
                                            placeholder="select month"
                                        />
                                        <button
                                            type="button"
                                            onclick="return applyFilter();"
                                            id="filterButton"
                                            class="btn btn-sm btn-dark"
                                        >
                                            Apply
                                        </button> 
                                        <button id="removeFilter" style="display: none;" onclick="clearFilter();"  class="btn btn-danger btn-sm">remove</button>
                                    </div>
                                    <div class="bg-white">
                                        <canvas
                                            id="monthlySalesChart"
                                            width="300"
                                            height="150"
                                            style="margin: 80px; background-color: white"
                                        ></canvas>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
<script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
<script src="assets/js/vendors/select2.min.js"></script>
<script src="assets/js/vendors/perfect-scrollbar.js"></script>
<script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
<script src="assets/js/vendors/chart.js"></script>
<!-- Main Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<script src="assets/js/main.js?v=1.1" type="text/javascript"></script>
<script src="assets/js/custom-chart.js" type="text/javascript"></script>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    async function applyFilter() {
        console.log("hiiiii");
        const filter = document.getElementById("filter").value;
        console.log(filter);
        if (filter) {
            const response = await axios.post("/admin/order-filter", {
                data: filter,
            });
            console.log("heloo", response.data);
            document.getElementById('removeFilter').style.display = 'inline-block';
            updateChart(response.data.data, response.data.newData);
        }
    }

    function clearFilter() {
        console.log('hello')
        window.location.reload();
    }

</script>

<script>
    function createMonthArray(year, month) {
        const daysInMonth = new Date(year, month, 0).getDate();
        console.log(daysInMonth);
        const monthArray = Array.from(
            { length: daysInMonth },
            (_, index) => index + 1
        );
        return monthArray;
    }
</script>

<!-- MOnthly sales bar graph -->
<script>
    const data = JSON.parse(
        document.getElementById("gragh").getAttribute("data-monthlyData")
    );
    const labels = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
    ];
    console.log(labels);
    const ctx = document.getElementById("monthlySalesChart").getContext("2d");

    const monthlySalesChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "2024",
                    data: data,
                    backgroundColor: "rgba(75, 192, 192, 0.5)", // Bar color
                    borderColor: "rgba(75, 192, 192, 1)", // Border color
                    borderWidth: 2, // Border width
                },
            ],
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true,
                },
                y: {
                    beginAtZero: true,
                },
            },
            plugins: {
                title: {
                    display: true,
                    text: "Monthly Sales Overview",
                    font: {
                        size: 16,
                        weight: "bold",
                    },
            },
            },
        },
    });

    function updateChart(month, newData) {
        const monthData = month.toString().split("-");
        const day = createMonthArray(monthData[0], monthData[1]);
        // Ensure monthlySalesChart exists before updating
        if (monthlySalesChart) {
            monthlySalesChart.data.labels = day;
            monthlySalesChart.data.datasets[0].data = newData;
            monthlySalesChart.update();
        } else {
            console.error("Chart instance not found. Cannot update.");
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<%-include('../layouts/adminFooter.ejs')%>